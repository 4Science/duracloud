<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns="http://www.springframework.org/schema/security"
             xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/security
           http://www.springframework.org/schema/security/spring-security-2.0.4.xsd">

  <!--
    A lot of Spring conventions here.
    This element wires together the
      authentication-manager, 
      access-decision-manager,
      various servlet filters (including basic-auth, anonymous, and exception-translation)
   -->
  <http access-decision-manager-ref="duraAccessDecisionManager"
        realm="DuraCloud:DuraStore">
    <!--
      Set initial access as if all spaces are 'open'.
      'closed' spaces will be handled by the spaceAccessVoter.
     -->
    <intercept-url pattern="/init" method="POST" access="ROLE_ROOT"/>
    <intercept-url pattern="/init" method="GET" access="ROLE_ANONYMOUS, ROLE_USER"/>

    <!-- no one should be adding the 'acl' space, not even ROOT -->
    <intercept-url pattern="/acl" method="PUT" access="ROLE_ROOT"/>
    <intercept-url pattern="/acl/" method="PUT" access="ROLE_ROOT"/>

    <intercept-url pattern="/stores" method="POST" access="ROLE_ROOT"/>
    <intercept-url pattern="/stores" method="GET" access="ROLE_USER"/>

    <intercept-url pattern="/security" method="POST" access="ROLE_ADMIN"/>
    <intercept-url pattern="/security" method="GET" access="ROLE_ADMIN"/>

    <intercept-url pattern="/**" method="PUT" access="ROLE_USER"/>
    <intercept-url pattern="/**" method="POST" access="ROLE_USER"/>
    <intercept-url pattern="/**" method="DELETE" access="ROLE_USER"/>

    <intercept-url pattern="/**" method="HEAD" access="ROLE_USER, ROLE_ANONYMOUS"/>
    <intercept-url pattern="/**" method="GET" access="ROLE_USER, ROLE_ANONYMOUS"/>

    <anonymous />
    <http-basic />
    <logout logout-url="/logout" />
  </http>

  <!-- The decision-voters here contribute to the AuthZ decision -->
  <beans:bean id="spaceReadAccessVoter" class="org.duracloud.security.vote.SpaceReadAccessVoter">
    <beans:constructor-arg ref="storageProviderFactory"/>
    <beans:constructor-arg ref="userDetailsSvc"/>
  </beans:bean>
  <beans:bean id="spaceWriteAccessVoter" class="org.duracloud.security.vote.SpaceWriteAccessVoter">
    <beans:constructor-arg ref="storageProviderFactory"/>
    <beans:constructor-arg ref="userDetailsSvc"/>
  </beans:bean>

  <beans:bean id="duraAccessDecisionManager" class="org.duracloud.security.vote.AccessDecisionManagerImpl">
    <beans:property name="allowIfAllAbstainDecisions" value="false"/>
    <beans:property name="decisionVoters">
      <beans:list>
        <beans:ref bean="spaceReadAccessVoter"/>
        <beans:ref bean="spaceWriteAccessVoter"/>
        <beans:bean class="org.duracloud.security.vote.RoleVoterImpl" />
      </beans:list>
    </beans:property>
  </beans:bean>

  <!-- AuthN Manager -->
  <authentication-manager alias="authenticationManager"/>
  <authentication-provider user-service-ref="userDetailsSvc">
    <password-encoder ref="passwordEncoder"/>
  </authentication-provider>
  <authentication-provider user-service-ref="userDetailsSvc"/>

  <beans:bean id="userDetailsSvc" class="org.duracloud.security.impl.UserDetailsServiceImpl">
  </beans:bean>

  <beans:bean id="passwordEncoder"
    class="org.springframework.security.providers.encoding.ShaPasswordEncoder" >
   <beans:constructor-arg value="256"/>
  </beans:bean>

</beans:beans>